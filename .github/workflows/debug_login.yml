name: Debug Login

on:
  workflow_dispatch: {}

jobs:
  debug:
    runs-on: ubuntu-latest
    env:
      STATE_JSON: ${{ secrets.NOTE_STORAGE_STATE_JSON }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install playwright
          npx playwright install --with-deps chromium

      - name: Create JSON and Run Debug Script
        run: |
          echo "$STATE_JSON" > state.json

          cat > debug.js <<'EOF'
          const { chromium } = require('playwright');
          const fs = require('fs');

          (async () => {
            console.log('ğŸš€ ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¹ãƒ†ãƒ«ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã™...');
            const browser = await chromium.launch({
              headless: true,
              args: ['--disable-blink-features=AutomationControlled', '--no-sandbox']
            });

            const context = await browser.newContext({
              storageState: 'state.json',
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              locale: 'ja-JP'
            });

            const page = await context.newPage();
            
            await page.addInitScript(() => {
              Object.defineProperty(navigator, 'webdriver', { get: () => undefined });
            });

            console.log('ğŸ”— noteã®ç·¨é›†ç”»é¢(editor.note.com/new)ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™...');
            try {
              await page.goto('https://editor.note.com/new', { waitUntil: 'domcontentloaded', timeout: 30000 });
              await page.waitForTimeout(3000);
            } catch (e) {
              console.log('âš ï¸ ã‚¢ã‚¯ã‚»ã‚¹ä¸­ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }

            const title = await page.title();
            const url = page.url();
            console.log(`\n=============================`);
            console.log(`ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«: ${title}`);
            console.log(`ç¾åœ¨ã®URL: ${url}`);
            console.log(`=============================\n`);

            await page.screenshot({ path: 'debug_result.png', fullPage: true });
            console.log('ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ: debug_result.png');

            await browser.close();
          })();
          EOF

          node debug.js

      - name: Upload Screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-result
          path: debug_result.png